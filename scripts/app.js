/**
 * Random number god
 * This code is an implementation of Alea algorithm; (C) 2010 Johannes Baagøe.
 * Alea is licensed according to the http://en.wikipedia.org/wiki/MIT_License.
 */

/**
     * @namespace
     * This code is an implementation of the ROT.js cellular map generation by Ondřej Žára, https://github.com/ondras/rot.js
     * Alea is licensed according to the http://en.wikipedia.org/wiki/MIT_License.
     */

/**
   * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
   * http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
   * requestAnimationFrame polyfill by Erik Möller. fixes from Paul Irish and Tino Zijdel
   * MIT license
   */

define("eventmanager",[""],function(){function e(e,n){topics.hasOwnProperty(e)||(topics[e]=[]);topics[e].push(n);return!0}function n(e,n){if(!topics.hasOwnProperty(e))return!1;for(var t=0,r=topics[e].length;r>t;t++)if(String(topics[e][t])===String(n)){topics[e].splice(t,1);return!0}return!1}function t(){var e=Array.prototype.slice.call(arguments),n=e.shift();if(!topics.hasOwnProperty(n))return!1;for(var t=0,r=topics[n].length;r>t;t++)topics[n][t].apply(void 0,e);return!0}topics={};return{subscribe:e,unsubscrive:n,publish:t,topics:topics}});define("scripts/app/controllers/uiController",["eventmanager"],function(e){ActorController=function(n){n.focus={};e.subscribe("actor.selected",function(t){n.focus.Uuid=t;e.subscribe("actor.object."+t,function(e){n.focus.actor=e;n.$digest()});e.publish("actor.getObject."+t)});e.subscribe("actor.unselected",function(t){if(n.focus.Uuid===t){e.unsubscrive("actor.object."+t,function(e){n.focus.actor=e;n.$digest()});n.focus.Uuid="";n.focus.actor="";n.$digest()}})};return["$scope","$interval",ActorController]});define("actorList",["eventmanager","underscore"],function(e){var n=[],t=[];e.subscribe("actor.create",function(e){n.push({uuid:e.variables.uuid,coordinates:e.variables.coordinates,sprite:e.variables.sprite,width:e.variables.width,height:e.variables.height,direction:e.variables.direction,state:e.variables.state,canvas:{},rendered:!1})});e.subscribe("actor.update",function(e){var t=_.findWhere(n,{uuid:e.variables.uuid});n=_.without(n,t);console.log(t.rendered);n.push({uuid:e.variables.uuid,coordinates:e.variables.coordinates,sprite:e.variables.sprite,rendered:t.rendered,canvas:t.canvas,direction:e.variables.direction,state:e.variables.state,spriteIndex:0})});e.subscribe("actor.delete",function(e){var r=_.findWhere(n,{uuid:e});t.push(r.variables.uuid);n=_.without(n,r)});var r=function(){return n},i=function(){return t},a=function(){t=[]};return{getCleanUpList:i,clearCleanUpList:a,getActorList:r}});define("RNG",[],function(){function e(){t(Date.now())}function n(){return u}function t(e){e=1>e?1/e:e;u=e;l=(e>>>0)*h;e=69069*e+1>>>0;f=e*h;e=69069*e+1>>>0;d=e*h;p=1}function r(){var e=2091639*l+p*h;l=f;f=d;p=0|e;d=e-p;return d}function i(e,n){do var t=2*r()-1,i=2*r()-1,a=t*t+i*i;while(a>1||0==a);var o=t*Math.sqrt(-2*Math.log(a)/a);return(e||0)+o*(n||1)}function a(){return 1+Math.floor(100*r())}function o(e){var n=0;for(var t in e)n+=e[t];var i=Math.floor(r()*n),a=0;for(var t in e){a+=e[t];if(a>i)return t}return null}function s(){return[l,f,d,p]}function c(e){l=e[0];f=e[1];d=e[2];p=e[3]}var u,l=0,f=0,d=0,p=0,h=2.3283064365386963e-10;e();return{getSeed:n,setSeed:t,getUniform:r,getNormal:i,getPercentage:a,getWeightedValue:o,getState:s,setState:c}});define("graphNode",[],function(){function e(e,n,t){this.data={};this.x=e;this.y=n;this.pos={x:e,y:n};this.type=t}var n={OPEN:0,WALL:1};e.prototype.toString=function(){return"["+this.x+" "+this.y+"]"};e.prototype.isWall=function(){return this.type==n.WALL};return e});define("graph",["graphNode"],function(e){function n(n){for(var t=[],r=0;r<n.length;r++){t[r]=[];for(var i=0,a=n[r];i<a.length;i++)t[r][i]=new e(r,i,a[i])}this.input=n;this.nodes=t}n.prototype.toString=function(){for(var e,n,t,r,i="\n",a=this.nodes,o=0,s=a.length;s>o;o++){e="";n=a[o];for(t=0,r=n.length;r>t;t++)e+=n[t].type+" ";i=i+e+"\n"}return i};return n});define("world",["RNG","underscore","graph","eventmanager"],function(e,n,t,r){function i(){w=n.compose(u,l,u,u,a,o)();v=new t(w)}function a(n){var t,r;for(t=0;g>t;t++)for(r=0;m>r;r++)n[t][r]=e.getUniform()<k?1:0;return n}function o(){var e,n,t=[];for(e=0;g>e;e++){t[e]=[];for(n=0;m>n;n++)t[e][n]=0}return t}function s(e,n,t){for(var r=0,i=0;i<W.length;i++){var a=W[i],o=n+a[0],s=t+a[1];0>o||o>=m||0>o||s>=m||(r+=1===e[o][s]?1:0)}return r}function c(e,n){var t={};t.x=(e-n)/2;t.y=(e+n)/2;return t}function u(e){for(var n=0,t=o(),r=0;g>r;r++){var i=1,a=0;if(6===L){i=2;a=r%2}for(var c=a;m>c;c+=i){n++;var u=e[c][r],l=s(e,c,r);u&&-1!==_.indexOf(l)?t[c][r]=1:u||-1===x.indexOf(l)||(t[c][r]=1)}}return t}function l(e){for(var n=[],t=2,r=0;g>r;r++)for(var i=0;t>i;i++){var a=r*t+i;n[a]=[];for(var o=0;m>o;o++)for(var s=0;t>s;s++){var c=o*t+s;n[a][c]=e[r][o]}}m*=t;g*=t;return n}function f(e,n){return e>=0&&n>=0&&m>e&&g>n?!1:!0}function d(e,n){return{x:e,y:n}}function p(e){return 0===w[e.y][e.x]?!0:!1}function h(){var e={x:0,y:0};1===I.up&&(e.y=e.y-.5);1===I.down&&(e.y=e.y+.5);1===I.left&&(e.x=e.x-.5);1===I.right&&(e.x=e.x+.5);if(0!==e.x||0!==e.y){e=d(C.x+e.x,C.y+e.y);C.x=e.x;C.y=e.y}}var v,g=30,m=30,b=132,y=66,w=[],x=[5,6,7,8],_=[4,5,6,7,8],L=8,C=c(m,g),k=.47,P={x:50,y:50},W=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],I={up:0,down:0,left:0,right:0};r.subscribe("new.frame",function(){h()});r.subscribe("pan.up",function(e){I.up=e});r.subscribe("pan.down",function(e){I.down=e});r.subscribe("pan.left",function(e){I.left=e});r.subscribe("pan.right",function(e){I.right=e});i();return{tileWidth:b,tileHeight:y,inBoundTile:d,outOfBound:f,tileIsOpen:p,height:g,width:m,mapData:w,center:C,padding:P,graph:v}});define("standardlib",["world","eventmanager"],function(e){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function t(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function r(e,n){var t={};t.x=n+e;t.y=n-e;return t}function i(e,n){var t={};t.x=(e-n)/2;t.y=(e+n)/2;return t}function a(n,t){var r=(n/(e.tileWidth/2)+t/(e.tileHeight/2))/2-e.width/2,i=(t/(e.tileHeight/2)-n/(e.tileWidth/2))/2+e.height/2;r=Math.floor(r);i=Math.floor(i);return{x:r,y:i}}function o(e,n){var t=setInterval(function(){e()&&clearInterval(t)},1e3)}return{guid:t,isoToTwoD:r,twoDToIso:i,worldPosToGridPos:a,checkWait:o}});define("actor",["eventmanager","actorList","standardlib","world"],function(e,n,t,r){return function(n){var i={};i.init=function(){_.each(i.handlers,function(n,t){_.each(n,function(n,r){e[t](r,i[n])})});e.publish("actor.create",i.getInfo())};i.variables={coordinates:n.coordinates,width:r.tileWidth,height:r.tileHeight,uuid:t.guid(),direction:"down",hp:0};i.handlers={subscribe:{"mouse.click.left":"checkLeftClick","actor.selected":"checkFocus"}};i.checkLeftClick=function(n){if(n.x==i.variables.coordinates.x&&n.y==i.variables.coordinates.y){i.variables.selected=!0;e.publish("actor.selected",i.variables.uuid)}else if(i.variables.selected){i.variables.selected=!1;e.publish("actor.unselected",i.variables.uuid)}};i.checkFocus=function(){};i.getInfo=function(){return i};i.destroy=function(){e.publish("actor.delete",variables.uuid)};return i}});define("binaryHeap",[""],function(){function e(e){this.content=[];this.scoreFunction=e}e.prototype={push:function(e){this.content.push(e);this.sinkDown(this.content.length-1)},pop:function(){var e=this.content[0],n=this.content.pop();if(this.content.length>0){this.content[0]=n;this.bubbleUp(0)}return e},remove:function(e){var n=this.content.indexOf(e),t=this.content.pop();if(n!==this.content.length-1){this.content[n]=t;this.scoreFunction(t)<this.scoreFunction(e)?this.sinkDown(n):this.bubbleUp(n)}},size:function(){return this.content.length},rescoreElement:function(e){this.sinkDown(this.content.indexOf(e))},sinkDown:function(e){for(var n=this.content[e];e>0;){var t=(e+1>>1)-1,r=this.content[t];if(!(this.scoreFunction(n)<this.scoreFunction(r)))break;this.content[t]=n;this.content[e]=r;e=t}},bubbleUp:function(e){for(var n=this.content.length,t=this.content[e],r=this.scoreFunction(t);;){var i=e+1<<1,a=i-1,o=null;if(n>a){var s=this.content[a],c=this.scoreFunction(s);r>c&&(o=a)}if(n>i){var u=this.content[i],l=this.scoreFunction(u);(null===o?r:c)>l&&(o=i)}if(null===o)break;this.content[e]=this.content[o];this.content[o]=t;e=o}}};return e});define("astar",["binaryHeap"],function(e){var n={init:function(e){for(var n=0,t=e.length;t>n;n++)for(var r=0,i=e[n].length;i>r;r++){var a=e[n][r];a.f=0;a.g=0;a.h=0;a.cost=a.type;a.visited=!1;a.closed=!1;a.parent=null}},heap:function(){return new e(function(e){return e.f})},search:function(e,t,r,i,a){n.init(e);a=a||n.manhattan;i=!!i;var o=n.heap();o.push(t);for(;o.size()>0;){var s=o.pop();if(s===r){for(var c=s,u=[];c.parent;){u.push(c);c=c.parent}return u.reverse()}s.closed=!0;for(var l=n.neighbors(e,s,i),f=0,d=l.length;d>f;f++){var p=l[f];if(!p.closed&&!p.isWall()){var h=s.g+p.cost,v=p.visited;if(!v||h<p.g){p.visited=!0;p.parent=s;p.h=p.h||a(p.pos,r.pos);p.g=h;p.f=p.g+p.h;v?o.rescoreElement(p):o.push(p)}}}}return[]},manhattan:function(e,n){var t=Math.abs(n.x-e.x),r=Math.abs(n.y-e.y);return t+r},neighbors:function(e,n,t){var r=[],i=n.x,a=n.y;e[i-1]&&e[i-1][a]&&r.push(e[i-1][a]);e[i+1]&&e[i+1][a]&&r.push(e[i+1][a]);e[i]&&e[i][a-1]&&r.push(e[i][a-1]);e[i]&&e[i][a+1]&&r.push(e[i][a+1]);if(t){e[i-1]&&e[i-1][a-1]&&r.push(e[i-1][a-1]);e[i+1]&&e[i+1][a-1]&&r.push(e[i+1][a-1]);e[i-1]&&e[i-1][a+1]&&r.push(e[i-1][a+1]);e[i+1]&&e[i+1][a+1]&&r.push(e[i+1][a+1])}return r}};return n});define("actor.unit",["actor","eventmanager","astar","world","underscore"],function(e,n,t,r){return function(i){var a=e(i),o={path:[],focus:"",strenght:0,dexterity:0,intelligence:0,health:0,death:!1,hp:50,attack:10},s={"new.gamecycle":"move"};_.extend(a.variables,o);_.extend(a.handlers.subscribe,s);a.generatePath=function(){var e=r.graph.nodes[a.variables.coordinates.y][a.variables.coordinates.x],n=r.graph.nodes[a.variables.goal.y][a.variables.goal.x];a.variables.path=t.search(r.graph.nodes,e,n,!0)};a.move=function(){if(0!==a.variables.path.length){var e=_.first(a.variables.path);a.variables.path=_.rest(a.variables.path);a.variables.coordinates={x:e.y,y:e.x};n.publish("command",{event:"actor.update",parameters:a})}};return a}});define("plane",["actor.unit","eventmanager"],function(e,n){return function(t){function r(e){setTimeout(function(){e.variables.direction<=2?e.variables.direction++:e.variables.direction=0;r(e);n.publish("actor.update",i.getInfo())},2e3)}var i=e(t),a={focus:"",state:"base",direction:3,sprite:{center:{x:24,y:20},base:{0:["plane/base/Plane_Large_face0_0.png","plane/base/Plane_Large_face0_1.png","plane/base/Plane_Large_face0_2.png","plane/base/Plane_Large_face0_3.png"],1:["plane/base/Plane_Large_face1_0.png","plane/base/Plane_Large_face1_1.png","plane/base/Plane_Large_face1_2.png","plane/base/Plane_Large_face1_3.png"],2:["plane/base/Plane_Large_face2_0.png","plane/base/Plane_Large_face2_1.png","plane/base/Plane_Large_face2_2.png","plane/base/Plane_Large_face2_3.png"],3:["plane/base/Plane_Large_face3_0.png","plane/base/Plane_Large_face3_1.png","plane/base/Plane_Large_face3_2.png","plane/base/Plane_Large_face3_3.png"]}}};_.extend(i.variables,a);r(i);return i}});define("scripts/app/controllers/gameController",["eventmanager","plane"],function(e,n){gameController=function(){var e=n({coordinates:{x:30,y:30}});e.init()};return["$scope","$timeout",gameController]});define("scripts/app/controllers/CanvasController",["eventmanager"],function(e){canvasController=function(){e.publish("game.init")};return["$scope",canvasController]});define("commandQueue",[""],function(){function e(e){r.push(e)}function n(){r=[]}function t(){return r}var r=[];return{add:e,get:t,clear:n}});define("command",["commandQueue","eventmanager"],function(e,n){function t(n){e.add(n)}function r(){var t=e.get();_.forEach(t,function(e){n.publish(e.event,e.parameters)});e.clear()}n.subscribe("command",function(e){t(e)});n.subscribe("new.gamecycle",function(){r()})});define("gamecycle",["eventmanager","command"],function(e){function n(){t()}function t(){setTimeout(t,200);e.publish("new.gamecycle")}e.subscribe("game.init",function(){n()})});define("text!assetsList",[],function(){return'{\n  "0" : {\n    "name": "mapTiles",\n    "type": "atlas",\n    "configuration": "./art/panama.json",\n    "file": "./art/panama.png"\n  }\n}'});define("spriteSheet",[""],function(){var e=function(e,n){var t=[],r=e,i=n,a=function(){_.forEach(r.frames,function(e){var n=e,t=.5*-n.frame.w,r=.5*-n.frame.h;if(n.trimmed){t=n.spriteSourceSize.x-.5*n.sourceSize.w;r=n.spriteSourceSize.y-.5*n.sourceSize.h}o(n.filename,n.frame.x,n.frame.y,n.frame.w,n.frame.h,t,r)})},o=function(e,n,r,i,a,o,s){var c={id:e,x:n,y:r,w:i,h:a,cx:null===o?0:o,cy:null===s?0:s};t.push(c)};a();return{img:i,sprites:t}};return e});define("assetLoader",["spriteSheet","underscore","jQuery"],function(e){var n=function(n){var t=this;_.forEach(n.config,function(r){t.queue++;switch(r.type){case"atlas":t.loadAtlas(r,function(i){n.loaded.atlas.push({name:r.name,sprite:new e(i.configuration,i.file)});t.queue--});break;case"music":}});return n},t=function(){return this.queue>0?!1:!0},r=function(e,n){jQuery.getJSON(e.configuration,function(n){e.configuration=n}).then(function(){var t=new Image;t.src=e.file;e.file=t;n(e)})};return{preloadassets:n,preloadComplete:t,loadAtlas:r}});define("assets",["text!assetsList","assetLoader","eventmanager"],function(e,n,t){function r(){var e=setInterval(function(){if(n.preloadComplete()){t.publish("assets.loaded");clearInterval(e)}},1e3)}var i={config:{},loaded:{atlas:[],music:[]}};i.config=JSON.parse(e);i=n.preloadassets(i);r();return i});define("RequestAnimationFrame",[""],function(){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/16.5)}}()});define("canvas",["eventmanager","world","standardlib"],function(e,n,t){var r={},i=function(){r.canvas=document.getElementById("mapCanvas");r.context=r.canvas.getContext("2d");r.canvas.width=n.width*n.tileWidth+2*n.padding.x;r.canvas.height=n.height*n.tileHeight+2*n.padding.y;r.canvas.addEventListener("contextmenu",function(n){var i=r.canvas.relmouseCoordinates(n);i=t.worldPosToGridPos(i.x,i.y,r.canvas.width);e.publish("map.click",i)},!1)};e.subscribe("game.init",function(){i()});return{terrain:r}});define("map",["eventmanager","canvas","world","standardlib","assets","underscore","jQuery"],function(e,n,t,r,i){function a(){o();c()}function o(){n.terrain.context.clearRect(0,0,n.terrain.canvas.width,n.terrain.canvas.height);for(var e={x:0,y:0},r=0;t.height>r;r++)for(var i=0;t.width>i;i++)t.outOfBound(e.y+r,e.x+i)||s(1===t.mapData[e.y+r][e.x+i]?{sprite:"trees_2.png",x:e.x+i,y:e.y+r}:{sprite:"landscapeTiles_067.png",x:e.x+i,y:e.y+r})}function s(e){var a,o,s;_.findIndex(i.loaded.atlas,function(n){a=_.findWhere(n.sprite.sprites,{id:e.sprite});s=n.sprite.img;!_.isEmpty(n)});if(!_.isEmpty(a)){o=r.twoDToIso(e.x,e.y);o.x=o.x*t.tileWidth+n.terrain.canvas.width/2-(a.w-t.tileWidth)/2-t.tileWidth/2;o.y=t.padding.y+o.y*t.tileHeight+(a.w/2-a.h);n.terrain.context.drawImage(s,a.x,a.y,a.w,a.h,o.x,o.y,a.w,a.h)}}function c(){var e=window.innerWidth/2,r=window.innerHeight/2,i={};i.x=-(t.center.x*t.tileWidth+n.terrain.canvas.width/2-e);i.y=-((t.center.y+1)*t.tileHeight)+r;$(n.terrain.canvas).css("margin-left",i.x).css("margin-top",i.y)}function u(){c(t.center)}e.subscribe("new.frame",function(){u()});e.subscribe("game.init",function(){a()})});define("actors",["eventmanager","standardlib","world","actorList","assets","jQuery","underscore"],function(e,n,t,r,i){function a(){_.each(r.getCleanUpList(),function(e){$("canvas."+e.uuid).remove()});r.clearCleanUpList();_.each(r.getActorList(),function(e){if(u(e.coordinates))if(e.rendered)o(e);else{$(".ActorsWrapper").append('<canvas id="'+e.uuid+'"></canvas>');e.canvas=document.getElementById(e.uuid);e.canvas.context=e.canvas.getContext("2d");e.rendered=!0;o(e)}else if(e.rendered){$("canvas#"+e.uuid).remove();e.rendered=!1;e.canvas=""}})}function o(e){s(e);c(e)}function s(e){var r=window.innerWidth/t.tileWidth,i=window.innerHeight/t.tileHeight,a=n.twoDToIso(e.coordinates.x,e.coordinates.y),o=t.center,s=a.y-o.y,c=(i/2-s)*t.tileHeight;$(e.canvas).css("bottom",c);var u=a.x-(o.x-r/2),l=u*t.tileWidth-e.sprite.center.x;$(e.canvas).css("left",l)}function c(e){"undefined"==typeof e.sprite[e.state][e.direction][e.spriteIndex]&&(e.spriteIndex=0);l({sprite:e.sprite[e.state][e.direction][e.spriteIndex],canvas:e.canvas});e.spriteIndex++}function u(e){var r=n.twoDToIso(e.x,e.y),i=t.center,a=Math.ceil(window.innerWidth/(t.tileWidth/2)),o=Math.ceil(window.innerHeight/(t.tileHeight/2));return r.x>=i.x-a/2&&r.x<=i.x+a/2&&r.y>=i.y-o/2&&r.y<=i.y+o/2?!0:!1}function l(e){var n,t;_.findIndex(i.loaded.atlas,function(r){n=_.findWhere(r.sprite.sprites,{id:e.sprite});t=r.sprite.img;!_.isEmpty(r)});if(!_.isEmpty(n)){e.canvas.context.clearRect(0,0,e.canvas.width,e.canvas.height);e.canvas.width=n.w;e.canvas.height=n.h;e.canvas.context.drawImage(t,n.x,n.y,n.w,n.h,0,0,n.w,n.h)}}e.subscribe("new.frame",function(){a()})});define("animate",["eventmanager","RequestAnimationFrame","map","actors"],function(e){function n(){e.publish("new.frame");window.setTimeout(n,100)}e.subscribe("game.init",function(){n()});return{}});define("mouse",["canvas","eventmanager"],function(e,n){HTMLCanvasElement.prototype.relmouseCoordinates=function(e){var n=0,t=0,r=0,i=0,a=this;do{n+=a.offsetLeft-a.scrollLeft;t+=a.offsetTop-a.scrollTop}while(a===a.offsetParent);r=e.pageX-n;i=e.pageY-t;return{x:r,y:i}};var t=function(){};n.subscribe("game.init",function(){t()})});define("input",["eventmanager","mouse","keypress"],function(e){var n=[{keys:"up",prevent_repeat:!0,on_keydown:function(){e.publish("pan.up",1)},on_keyup:function(){e.publish("pan.up",0)}},{keys:"down",prevent_repeat:!0,on_keydown:function(){e.publish("pan.down",1)},on_keyup:function(){e.publish("pan.down",0)}},{keys:"left",prevent_repeat:!0,on_keydown:function(){e.publish("pan.left",1)},on_keyup:function(){e.publish("pan.left",0)}},{keys:"right",prevent_repeat:!0,on_keydown:function(){e.publish("pan.right",1)},on_keyup:function(){e.publish("pan.right",0)}}];keypress.register_many(n)});define("scripts/app",["scripts/app/controllers/uiController","scripts/app/controllers/gameController","scripts/app/controllers/CanvasController","angular","angular-ui-router","gamecycle","assets","animate","input"],function(e,n,t){var r=angular.module("panama",["ui.router"]);r.config(["$stateProvider",function(e){e.state("menu",{templateUrl:"templates/menu.html"}).state("game",{"abstract":!0,templateUrl:"templates/game.html",controller:"gameController"}).state("game.content",{views:{canvas:{templateUrl:"templates/game.canvas.html",controller:"canvasController"},actor:{templateUrl:"templates/game.ui.html",controller:"uiController"}}})}]);r.controller("uiController",e);r.controller("gameController",n);r.controller("canvasController",t);r.run(["$state",function(e){e.transitionTo("game.content")}]);angular.element(document).ready(function(){angular.bootstrap(document,["panama"])});return r});