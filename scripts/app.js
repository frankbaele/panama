/**
 * Random number god
 * This code is an implementation of Alea algorithm; (C) 2010 Johannes Baagøe.
 * Alea is licensed according to the http://en.wikipedia.org/wiki/MIT_License.
 */

/**
     * @namespace
     * This code is an implementation of the ROT.js cellular map generation by Ondřej Žára, https://github.com/ondras/rot.js
     * Alea is licensed according to the http://en.wikipedia.org/wiki/MIT_License.
     */

/**
   * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
   * http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
   * requestAnimationFrame polyfill by Erik Möller. fixes from Paul Irish and Tino Zijdel
   * MIT license
   */

define("eventmanager",[""],function(){function t(t,e){topics.hasOwnProperty(t)||(topics[t]=[]);topics[t].push(e);return!0}function e(t,e){if(!topics.hasOwnProperty(t))return!1;for(var n=0,i=topics[t].length;i>n;n++)if(String(topics[t][n])===String(e)){topics[t].splice(n,1);return!0}return!1}function n(){var t=Array.prototype.slice.call(arguments),e=t.shift();if(!topics.hasOwnProperty(e))return!1;for(var n=0,i=topics[e].length;i>n;n++)topics[e][n].apply(void 0,t);return!0}topics={};return{subscribe:t,unsubscrive:e,publish:n,topics:topics}});define("scripts/app/controllers/uiController",["eventmanager"],function(t){ActorController=function(e){e.focus={};t.subscribe("actor.selected",function(n){e.focus.Uuid=n;t.subscribe("actor.object."+n,function(t){e.focus.actor=t;e.$digest()});t.publish("actor.getObject."+n)});t.subscribe("actor.unselected",function(n){if(e.focus.Uuid===n){t.unsubscrive("actor.object."+n,function(t){e.focus.actor=t;e.$digest()});e.focus.Uuid="";e.focus.actor="";e.$digest()}})};return["$scope","$interval",ActorController]});define("RNG",[],function(){function t(){n(Date.now())}function e(){return u}function n(t){t=1>t?1/t:t;u=t;l=(t>>>0)*d;t=69069*t+1>>>0;f=t*d;t=69069*t+1>>>0;h=t*d;p=1}function i(){var t=2091639*l+p*d;l=f;f=h;p=0|t;h=t-p;return h}function r(t,e){do var n=2*i()-1,r=2*i()-1,o=n*n+r*r;while(o>1||0==o);var a=n*Math.sqrt(-2*Math.log(o)/o);return(t||0)+a*(e||1)}function o(){return 1+Math.floor(100*i())}function a(t){var e=0;for(var n in t)e+=t[n];var r=Math.floor(i()*e),o=0;for(var n in t){o+=t[n];if(o>r)return n}return null}function s(){return[l,f,h,p]}function c(t){l=t[0];f=t[1];h=t[2];p=t[3]}var u,l=0,f=0,h=0,p=0,d=2.3283064365386963e-10;t();return{getSeed:e,setSeed:n,getUniform:i,getNormal:r,getPercentage:o,getWeightedValue:a,getState:s,setState:c}});define("graphNode",[],function(){function t(t,e,n){this.data={};this.x=t;this.y=e;this.pos={x:t,y:e};this.type=n}var e={OPEN:0,WALL:1};t.prototype.toString=function(){return"["+this.x+" "+this.y+"]"};t.prototype.isWall=function(){return this.type==e.WALL};return t});define("graph",["graphNode"],function(t){function e(e){for(var n=[],i=0;i<e.length;i++){n[i]=[];for(var r=0,o=e[i];r<o.length;r++)n[i][r]=new t(i,r,o[r])}this.input=e;this.nodes=n}e.prototype.toString=function(){for(var t,e,n,i,r="\n",o=this.nodes,a=0,s=o.length;s>a;a++){t="";e=o[a];for(n=0,i=e.length;i>n;n++)t+=e[n].type+" ";r=r+t+"\n"}return r};return e});define("collisionGrid",["eventmanager"],function(){var t=function(t){this.data=t},e=function(){},n=function(){},i=function(){},r=function(){};return{init:t,add:e,remove:n,update:i,isOpen:r}});define("world",["RNG","underscore","graph","eventmanager","collisionGrid"],function(t,e,n,i,r){function o(){w=e.compose(u,l,u,u,a,s)();v=new n(w);r.init(w)}function a(e){var n,i;for(n=0;g>n;n++)for(i=0;m>i;i++)e[n][i]=t.getUniform()<A?1:0;return e}function s(){var t,e,n=[];for(t=0;g>t;t++){n[t]=[];for(e=0;m>e;e++)n[t][e]=0}return n}function c(t,e,n){for(var i=0,r=0;r<T.length;r++){var o=T[r],a=e+o[0],s=n+o[1];0>a||a>=m||0>a||s>=m||(i+=1===t[a][s]?1:0)}return i}function u(t){for(var e=0,n=s(),i=0;g>i;i++){var r=1,o=0;if(6===C){r=2;o=i%2}for(var a=o;m>a;a+=r){e++;var u=t[a][i],l=c(t,a,i);u&&-1!==k.indexOf(l)?n[a][i]=1:u||-1===x.indexOf(l)||(n[a][i]=1)}}return n}function l(t){for(var e=[],n=2,i=0;g>i;i++)for(var r=0;n>r;r++){var o=i*n+r;e[o]=[];for(var a=0;m>a;a++)for(var s=0;n>s;s++){var c=a*n+s;e[o][c]=t[i][a]}}m*=n;g*=n;return e}function f(t,e){return t>=0&&e>=0&&m>t&&g>e?!1:!0}function h(t,e){if(f(t,e)){0>=t?t=0:t>=m&&(t=m-1);0>=e?e=0:e>=g&&(e=g-1)}return{x:t,y:e}}function p(t){return 0===w[t.y][t.x]?!0:!1}function d(){var t={x:0,y:0};if(1===S.up){t.y--;t.x--}if(1===S.down){t.y++;t.x++}if(1===S.left){t.x--;t.y++}if(1===S.right){t.x++;t.y--}if(0!==t.x||0!==t.y){t=h(_.x+t.x,_.y+t.y);_.x=t.x;_.y=t.y}}var v,g=30,m=30,b=132,y=66,w=[],x=[5,6,7,8],k=[4,5,6,7,8],C=8,_={x:m,y:g},A=.47,L={x:50,y:50},T=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],S={up:0,down:0,left:0,right:0};i.subscribe("new.frame",function(){d()});i.subscribe("pan.up",function(t){S.up=t});i.subscribe("pan.down",function(t){S.down=t});i.subscribe("pan.left",function(t){S.left=t});i.subscribe("pan.right",function(t){S.right=t});o();return{tileWidth:b,tileHeight:y,inBoundTile:h,outOfBound:f,tileIsOpen:p,height:g,width:m,mapData:w,center:_,padding:L,graph:v}});define("standardlib",["world","eventmanager"],function(t){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function n(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function i(t,e){var n={};n.x=e+t;n.y=e-t;return n}function r(t,e){var n={};n.x=(t-e)/2;n.y=(t+e)/2;return n}function o(e,n){var i=(e/(t.tileWidth/2)+n/(t.tileHeight/2))/2-t.width/2,r=(n/(t.tileHeight/2)-e/(t.tileWidth/2))/2+t.height/2;i=Math.floor(i);r=Math.floor(r);return{x:i,y:r}}function a(t,e){var n=setInterval(function(){t()&&clearInterval(n)},1e3)}return{guid:n,isoToTwoD:i,twoDToIso:r,worldPosToGridPos:o,checkWait:a}});define("actorList",["eventmanager","underscore"],function(t){var e=[],n=[];t.subscribe("actor.create",function(t){e.push({uuid:t.variables.uuid,coordinates:t.variables.coordinates,sprite:t.variables.sprite})});t.subscribe("actor.update",function(t){var i=_.findWhere(e,{uuid:t.variables.uuid});n.push({coordinates:i.coordinates});e=_.without(e,i);e.push({uuid:t.variables.uuid,coordinates:t.variables.coordinates,sprite:t.variables.sprite})});t.subscribe("actor.delete",function(t){var i=_.findWhere(e,{uuid:t});n.push({coordinates:i.coordinates});e=_.without(e,i)});var i=function(){return e},r=function(){return n},o=function(){n=[]};return{getCleanUpList:r,clearCleanUpList:o,getActorList:i}});define("actor",["eventmanager","standardlib","actorList"],function(eventmanager,standardlib){var Actor=function(sprite,coordinates){this.variables.coordinates=coordinates;this.variables.sprite=sprite;var that=this;_.each(this.handlers,function(handlers,type){"publish"==type?_.each(handlers,function(handler,event){eventmanager[type](event,eval(handler))}):_.each(handlers,function(handler,event){eventmanager[type](event,function(object){eval(handler)})})})};Actor.prototype.variables={coordinates:"",sprite:"",uuid:standardlib.guid(),hp:0};Actor.prototype.handlers={publish:{"actor.create":"that;"},subscribe:{"mouse.click.right":"that.checkRightClick(object);","mouse.click.left":"that.checkLeftClick(object);","actor.selected":"that.focus = object;","actor.unselected":'if(that.focus === object){that.focus = "";}',"actor.delete":'if(that.focus === object){that.focus = "";}',"new.gamecycle":"that.move();"}};Actor.prototype.checkLeftClick=function(t){if(t.x==this.variables.coordinates.x&&t.y==this.variables.coordinates.y){this.variables.selected=!0;eventmanager.publish("actor.selected",this.variables.uuid)}else if(this.variables.selected){this.variables.selected=!1;eventmanager.publish("actor.unselected",this.variables.uuid)}};Actor.prototype.delete=function(){eventmanager.publish("actor.delete",this.variables.uuid)};Actor.prototype.getInfo=function(){return this.variables};return Actor});define("binaryHeap",[""],function(){function t(t){this.content=[];this.scoreFunction=t}t.prototype={push:function(t){this.content.push(t);this.sinkDown(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();if(this.content.length>0){this.content[0]=e;this.bubbleUp(0)}return t},remove:function(t){var e=this.content.indexOf(t),n=this.content.pop();if(e!==this.content.length-1){this.content[e]=n;this.scoreFunction(n)<this.scoreFunction(t)?this.sinkDown(e):this.bubbleUp(e)}},size:function(){return this.content.length},rescoreElement:function(t){this.sinkDown(this.content.indexOf(t))},sinkDown:function(t){for(var e=this.content[t];t>0;){var n=(t+1>>1)-1,i=this.content[n];if(!(this.scoreFunction(e)<this.scoreFunction(i)))break;this.content[n]=e;this.content[t]=i;t=n}},bubbleUp:function(t){for(var e=this.content.length,n=this.content[t],i=this.scoreFunction(n);;){var r=t+1<<1,o=r-1,a=null;if(e>o){var s=this.content[o],c=this.scoreFunction(s);i>c&&(a=o)}if(e>r){var u=this.content[r],l=this.scoreFunction(u);(null===a?i:c)>l&&(a=r)}if(null===a)break;this.content[t]=this.content[a];this.content[a]=n;t=a}}};return t});define("astar",["binaryHeap"],function(t){var e={init:function(t){for(var e=0,n=t.length;n>e;e++)for(var i=0,r=t[e].length;r>i;i++){var o=t[e][i];o.f=0;o.g=0;o.h=0;o.cost=o.type;o.visited=!1;o.closed=!1;o.parent=null}},heap:function(){return new t(function(t){return t.f})},search:function(t,n,i,r,o){e.init(t);o=o||e.manhattan;r=!!r;var a=e.heap();a.push(n);for(;a.size()>0;){var s=a.pop();if(s===i){for(var c=s,u=[];c.parent;){u.push(c);c=c.parent}return u.reverse()}s.closed=!0;for(var l=e.neighbors(t,s,r),f=0,h=l.length;h>f;f++){var p=l[f];if(!p.closed&&!p.isWall()){var d=s.g+p.cost,v=p.visited;if(!v||d<p.g){p.visited=!0;p.parent=s;p.h=p.h||o(p.pos,i.pos);p.g=d;p.f=p.g+p.h;v?a.rescoreElement(p):a.push(p)}}}}return[]},manhattan:function(t,e){var n=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return n+i},neighbors:function(t,e,n){var i=[],r=e.x,o=e.y;t[r-1]&&t[r-1][o]&&i.push(t[r-1][o]);t[r+1]&&t[r+1][o]&&i.push(t[r+1][o]);t[r]&&t[r][o-1]&&i.push(t[r][o-1]);t[r]&&t[r][o+1]&&i.push(t[r][o+1]);if(n){t[r-1]&&t[r-1][o-1]&&i.push(t[r-1][o-1]);t[r+1]&&t[r+1][o-1]&&i.push(t[r+1][o-1]);t[r-1]&&t[r-1][o+1]&&i.push(t[r-1][o+1]);t[r+1]&&t[r+1][o+1]&&i.push(t[r+1][o+1])}return i}};return e});define("actor.unit",["actor","eventmanager","astar","world","underscore"],function(t,e,n,i){var r=t,o={path:[],focus:"",strenght:0,dexterity:0,intelligence:0,health:0,death:!1,hp:50,attack:10};_.extend(r.prototype.variables,o);r.prototype.generatePath=function(){var t=i.graph.nodes[this.variables.coordinates.y][this.variables.coordinates.x],e=i.graph.nodes[this.variables.goal.y][this.variables.goal.x];this.variables.path=n.search(i.graph.nodes,t,e,!0)};r.prototype.move=function(){if(0!==this.variables.path.length){console.log("move");var t=_.first(this.variables.path);this.variables.path=_.rest(this.variables.path);this.variables.coordinates={x:t.y,y:t.x};e.publish("command",{event:"actor.update",parameters:this})}};r.prototype.checkDeath=function(){if(this.hp<=0&&!this.death){this.death=!0;this.delete()}};r.prototype.attackActor=function(){""!==this.focus&&this.focus!==this.uuid&&e.publish("command",{event:"actor.attack."+this.focus,parameters:this.attack})};return r});define("actor.unit.local",["actor.unit","eventmanager"],function(t){var e=t,n={focus:""};_.extend(e.prototype.variables,n);e.prototype.checkRightClick=function(t){this.variables.goal=t;this.generatePath()};return e});define("scripts/app/controllers/gameController",["eventmanager","actor.unit.local"],function(t,e){gameController=function(){new e("tower_13.png",{x:0,y:0})};return["$scope",gameController]});define("scripts/app/controllers/CanvasController",["eventmanager"],function(t){canvasController=function(){t.publish("game.init")};return["$scope",canvasController]});define("commandQueue",[""],function(){function t(t){i.push(t)}function e(){i=[]}function n(){return i}var i=[];return{add:t,get:n,clear:e}});define("command",["commandQueue","eventmanager"],function(t,e){function n(e){t.add(e)}function i(){var n=t.get();_.forEach(n,function(t){e.publish(t.event,t.parameters)});t.clear()}e.subscribe("command",function(t){n(t)});e.subscribe("new.gamecycle",function(){i()})});define("gamecycle",["eventmanager","command"],function(t){function e(){n()}function n(){setTimeout(n,200);t.publish("new.gamecycle")}t.subscribe("game.init",function(){e()})});define("text!assetsList",[],function(){return'{\n  "0" : {\n    "name": "mapTiles",\n    "type": "atlas",\n    "configuration": "./art/panama.json",\n    "file": "./art/panama.png"\n  }\n}'});define("spriteSheet",[""],function(){var t=function(t,e){var n=[],i=t,r=e,o=function(){_.forEach(i.frames,function(t){var e=t,n=.5*-e.frame.w,i=.5*-e.frame.h;if(e.trimmed){n=e.spriteSourceSize.x-.5*e.sourceSize.w;i=e.spriteSourceSize.y-.5*e.sourceSize.h}a(e.filename,e.frame.x,e.frame.y,e.frame.w,e.frame.h,n,i)})},a=function(t,e,i,r,o,a,s){var c={id:t,x:e,y:i,w:r,h:o,cx:null===a?0:a,cy:null===s?0:s};n.push(c)};o();return{img:r,sprites:n}};return t});define("assetLoader",["spriteSheet","underscore","jQuery"],function(t){var e=function(e){var n=this;_.forEach(e.config,function(i){n.queue++;switch(i.type){case"atlas":n.loadAtlas(i,function(r){e.loaded.atlas.push({name:i.name,sprite:new t(r.configuration,r.file)});n.queue--});break;case"music":}});return e},n=function(){return this.queue>0?!1:!0},i=function(t,e){jQuery.getJSON(t.configuration,function(e){t.configuration=e}).then(function(){var n=new Image;n.src=t.file;t.file=n;e(t)})};return{preloadassets:e,preloadComplete:n,loadAtlas:i}});define("assets",["text!assetsList","assetLoader","eventmanager"],function(t,e,n){function i(){var t=setInterval(function(){if(e.preloadComplete()){n.publish("assets.loaded");clearInterval(t)}},1e3)}var r={config:{},loaded:{atlas:[],music:[]}};r.config=JSON.parse(t);r=e.preloadassets(r);i();return r});define("RequestAnimationFrame",[""],function(){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/16.5)}}()});define("canvas",["eventmanager","world"],function(t,e){var n={},i={},r=function(){n.canvas=document.getElementById("mapCanvas");n.context=n.canvas.getContext("2d");i.canvas=document.getElementById("actorsCanvas");i.context=i.canvas.getContext("2d");n.canvas.width=e.width*e.tileWidth+2*e.padding.x;n.canvas.height=e.height*e.tileHeight+2*e.padding.y;i.canvas.width=window.innerWidth;i.canvas.height=window.innerHeight};t.subscribe("game.init",function(){r()});return{terrain:n,actors:i}});define("map",["eventmanager","canvas","world","standardlib","assets","underscore","jQuery"],function(t,e,n,i,r){function o(){a();c(n.center)}function a(){e.terrain.context.clearRect(0,0,e.terrain.canvas.width,e.terrain.canvas.height);for(var t={x:0,y:0},i=0;n.height>i;i++)for(var r=0;n.width>r;r++)n.outOfBound(t.y+i,t.x+r)||s(1===n.mapData[t.y+i][t.x+r]?{sprite:"trees_2.png",x:t.x+r,y:t.y+i}:{sprite:"landscapeTiles_067.png",x:t.x+r,y:t.y+i})}function s(t){var o,a,s;_.findIndex(r.loaded.atlas,function(e){o=_.findWhere(e.sprite.sprites,{id:t.sprite});s=e.sprite.img;!_.isEmpty(e)});if(!_.isEmpty(o)){a=i.twoDToIso(t.x,t.y);a.x=a.x*n.tileWidth+e.terrain.canvas.width/2-(o.w-n.tileWidth)/2-n.tileWidth/2;a.y=n.padding.y+a.y*n.tileHeight+(o.w/2-o.h);e.terrain.context.drawImage(s,o.x,o.y,o.w,o.h,a.x,a.y,o.w,o.h)}}function c(t){var r=e.actors.canvas.width/2,o=e.actors.canvas.height/2,a=i.twoDToIso(t.x,t.y);a.x=-(a.x*n.tileWidth+e.terrain.canvas.width/2-r);a.y=-((a.y-1)*n.tileHeight+n.tileHeight/2)+o;$(e.terrain.canvas).css("margin-left",a.x).css("margin-top",a.y)}function u(){c(n.center)}t.subscribe("new.frame",function(){u()});t.subscribe("game.init",function(){o()})});define("actors",["eventmanager","standardlib","world","canvas","actorList","underscore"],function(t,e,n,i,r){function o(){}t.subscribe("game.init",function(){o()})});define("animate",["eventmanager","RequestAnimationFrame","map","actors"],function(t){function e(){t.publish("new.frame");window.setTimeout(e,50)}t.subscribe("game.init",function(){e()});return{}});define("mouse",["canvas","standardlib","eventmanager"],function(t,e,n){function i(t){o=t}function r(t){a=t}var o=function(){console.log("The right mouse click is not assigned, define leftmouseCallback")},a=function(){console.log("The left mouse click is not assigned, define rightmouseCallback")};HTMLCanvasElement.prototype.relmouseCoordinates=function(t){var e=0,n=0,i=0,r=0,o=this;do{e+=o.offsetLeft-o.scrollLeft;n+=o.offsetTop-o.scrollTop}while(o===o.offsetParent);i=t.pageX-e;r=t.pageY-n;return{x:i,y:r}};window.oncontextmenu=function(t){t.preventDefault();t.stopPropagation();return!1};var s=function(){t.actors.canvas.addEventListener("click",function(n){var i=t.actors.canvas.relmouseCoordinates(n);i=e.worldPosToGridPos(i.x,i.y,t.actors.canvas.width);o(i)},!1);t.actors.canvas.addEventListener("contextmenu",function(n){var i=t.actors.canvas.relmouseCoordinates(n);i=e.worldPosToGridPos(i.x,i.y,t.actors.canvas.width);a(i)},!1)};n.subscribe("game.init",function(){s()});return{setLeftmouseCallback:i,setRightmouseCallback:r}});define("input",["eventmanager","mouse","keypress"],function(t,e){var n=[{keys:"up",prevent_repeat:!0,on_keydown:function(){t.publish("pan.up",1)},on_keyup:function(){t.publish("pan.up",0)}},{keys:"down",prevent_repeat:!0,on_keydown:function(){t.publish("pan.down",1)},on_keyup:function(){t.publish("pan.down",0)}},{keys:"left",prevent_repeat:!0,on_keydown:function(){t.publish("pan.left",1)},on_keyup:function(){t.publish("pan.left",0)}},{keys:"right",prevent_repeat:!0,on_keydown:function(){t.publish("pan.right",1)},on_keyup:function(){t.publish("pan.right",0)}}];keypress.register_many(n);e.setLeftmouseCallback(function(e){t.publish("mouse.click.left",e)});e.setRightmouseCallback(function(e){t.publish("mouse.click.right",e)})});define("scripts/app",["scripts/app/controllers/uiController","scripts/app/controllers/gameController","scripts/app/controllers/CanvasController","angular","angular-ui-router","gamecycle","assets","animate","input"],function(t,e,n){var i=angular.module("panama",["ui.router"]);i.config(["$stateProvider",function(t){t.state("menu",{templateUrl:"templates/menu.html"}).state("game",{"abstract":!0,templateUrl:"templates/game.html",controller:"gameController"}).state("game.content",{views:{canvas:{templateUrl:"templates/game.canvas.html",controller:"canvasController"},actor:{templateUrl:"templates/game.ui.html",controller:"uiController"}}})}]);i.controller("uiController",t);i.controller("gameController",e);i.controller("canvasController",n);i.run(["$state",function(t){t.transitionTo("game.content")}]);angular.element(document).ready(function(){angular.bootstrap(document,["panama"])});return i});