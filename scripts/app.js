/**
 * Random number god
 * This code is an implementation of Alea algorithm; (C) 2010 Johannes Baagøe.
 * Alea is licensed according to the http://en.wikipedia.org/wiki/MIT_License.
 */

/**
     * @namespace
     * This code is an implementation of the ROT.js cellular map generation by Ondřej Žára, https://github.com/ondras/rot.js
     * Alea is licensed according to the http://en.wikipedia.org/wiki/MIT_License.
     */

/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

/**
   * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
   * http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
   * requestAnimationFrame polyfill by Erik Möller. fixes from Paul Irish and Tino Zijdel
   * MIT license
   */

define("eventmanager",[""],function(){function e(e,n){topics.hasOwnProperty(e)||(topics[e]=[]);topics[e].push(n);return!0}function n(e,n){if(!topics.hasOwnProperty(e))return!1;for(var t=0,r=topics[e].length;r>t;t++)if(String(topics[e][t])===String(n)){topics[e].splice(t,1);return!0}return!1}function t(){var e=Array.prototype.slice.call(arguments),n=e.shift();if(!topics.hasOwnProperty(n))return!1;for(var t=0,r=topics[n].length;r>t;t++)topics[n][t].apply(void 0,e);return!0}topics={};return{subscribe:e,unsubscrive:n,publish:t,topics:topics}});define("actorList",["eventmanager"],function(e){var n=[],t=[];e.subscribe("actor.create",function(e){n.push(e)});e.subscribe("actor.update",function(e){var t=_.findWhere(n,{uuid:e.variables.uuid});_.merge(t,e)});e.subscribe("actor.delete",function(e){var r=_.findWhere(n,{uuid:e});t.push(r.variables.uuid);n=_.without(n,r)});var r=function(){return n},i=function(){return t},o=function(){t=[]};return{getCleanUpList:i,clearCleanUpList:o,getActorList:r}});define("RNG",[],function(){function e(){t(Date.now())}function n(){return u}function t(e){e=1>e?1/e:e;u=e;p=(e>>>0)*h;e=69069*e+1>>>0;l=e*h;e=69069*e+1>>>0;f=e*h;d=1}function r(){var e=2091639*p+d*h;p=l;l=f;d=0|e;f=e-d;return f}function i(e,n){do var t=2*r()-1,i=2*r()-1,o=t*t+i*i;while(o>1||0==o);var a=t*Math.sqrt(-2*Math.log(o)/o);return(e||0)+a*(n||1)}function o(){return 1+Math.floor(100*r())}function a(e){var n=0;for(var t in e)n+=e[t];var i=Math.floor(r()*n),o=0;for(var t in e){o+=e[t];if(o>i)return t}return null}function c(){return[p,l,f,d]}function s(e){p=e[0];l=e[1];f=e[2];d=e[3]}var u,p=0,l=0,f=0,d=0,h=2.3283064365386963e-10;e();return{getSeed:n,setSeed:t,getUniform:r,getNormal:i,getPercentage:o,getWeightedValue:a,getState:c,setState:s}});define("graphNode",[],function(){function e(e,n,t){this.data={};this.x=e;this.y=n;this.pos={x:e,y:n};this.type=t}var n={OPEN:0,WALL:1};e.prototype.toString=function(){return"["+this.x+" "+this.y+"]"};e.prototype.isWall=function(){return this.type==n.WALL};return e});define("graph",["graphNode"],function(e){function n(n){for(var t=[],r=0;r<n.length;r++){t[r]=[];for(var i=0,o=n[r];i<o.length;i++)t[r][i]=new e(r,i,o[i])}this.input=n;this.nodes=t}n.prototype.toString=function(){for(var e,n,t,r,i="\n",o=this.nodes,a=0,c=o.length;c>a;a++){e="";n=o[a];for(t=0,r=n.length;r>t;t++)e+=n[t].type+" ";i=i+e+"\n"}return i};return n});define("world",["RNG","graph","eventmanager"],function(e,n,t){function r(){x=_.compose(s,u,s,s,i,o)();h=new n(x)}function i(n){var t,r;for(t=0;v>t;t++)for(r=0;g>r;r++)n[t][r]=e.getUniform()<k?1:0;return n}function o(){var e,n,t=[];for(e=0;v>e;e++){t[e]=[];for(n=0;g>n;n++)t[e][n]=0}return t}function a(e,n,t){for(var r=0,i=0;i<j.length;i++){var o=j[i],a=n+o[0],c=t+o[1];0>a||a>=g||0>a||c>=g||(r+=1===e[a][c]?1:0)}return r}function c(e,n){var t={};t.x=(e-n)/2;t.y=(e+n)/2;return t}function s(e){for(var n=0,t=o(),r=0;v>r;r++){var i=1,c=0;if(6===P){i=2;c=r%2}for(var s=c;g>s;s+=i){n++;var u=e[s][r],p=a(e,s,r);u&&-1!==w.indexOf(p)?t[s][r]=1:u||-1===b.indexOf(p)||(t[s][r]=1)}}return t}function u(e){for(var n=[],t=2,r=0;v>r;r++)for(var i=0;t>i;i++){var o=r*t+i;n[o]=[];for(var a=0;g>a;a++)for(var c=0;t>c;c++){var s=a*t+c;n[o][s]=e[r][a]}}g*=t;v*=t;return n}function p(e,n){return e>=0&&n>=0&&g>e&&v>n?!1:!0}function l(e,n){return{x:e,y:n}}function f(e){return 0===x[e.y][e.x]?!0:!1}function d(){var e={x:0,y:0};1===T.up&&(e.y=e.y-1);1===T.down&&(e.y=e.y+1);1===T.left&&(e.x=e.x-1);1===T.right&&(e.x=e.x+1);if(0!==e.x||0!==e.y){e=l(L.x+e.x,L.y+e.y);L.x=e.x;L.y=e.y;t.publish("center.update.start")}else t.publish("center.update.stop")}var h,v=30,g=30,y=132,m=66,x=[],b=[5,6,7,8],w=[4,5,6,7,8],P=8,L=c(0,0),k=.47,j=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],T={up:0,down:0,left:0,right:0};t.subscribe("new.frame",function(){d()});t.subscribe("pan.up",function(e){T.up=e});t.subscribe("pan.down",function(e){T.down=e});t.subscribe("pan.left",function(e){T.left=e});t.subscribe("pan.right",function(e){T.right=e});r();return{tileWidth:y,tileHeight:m,inBoundTile:l,outOfBound:p,tileIsOpen:f,height:v,width:g,mapData:x,center:L,graph:h}});define("standardlib",["world","eventmanager"],function(e){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function t(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function r(e,n){var t={};t.x=n+e;t.y=n-e;return t}function i(e,n){var t={};t.x=(e-n)/2;t.y=(e+n)/2;return t}function o(n,t){n-=e.width/2*e.tileWidth;var r=(n/(e.tileWidth/2)+t/(e.tileHeight/2))/2,i=(t/(e.tileHeight/2)-n/(e.tileWidth/2))/2;r=Math.floor(r);i=Math.floor(i);return{x:r,y:i}}function a(){}function c(e,n){var t=setInterval(function(){e()&&clearInterval(t)},1e3)}return{guid:t,isoToTwoD:r,twoDToIso:i,worldPosToGridPos:o,windowPosToGridPos:a,checkWait:c}});define("actor",["eventmanager","actorList","standardlib","world"],function(e,n,t,r){return function(n){var i={};i.init=function(){_.each(i.handlers,function(n,t){_.each(n,function(n,r){e[t](r,i[n])})});e.publish("actor.create",i.getInfo())};i.variables={coordinates:n.coordinates,width:r.tileWidth,height:r.tileHeight,uuid:t.guid(),direction:"down",hp:0,rendered:!1,canvas:{}};i.handlers={subscribe:{"actor.selected":"actorSelect"}};i.actorSelect=function(e){i.variables.selected=i.variables.uuid==e?!0:!1};i.getInfo=function(){return i};i.destroy=function(){e.publish("actor.delete",variables.uuid)};return i}});define("binaryHeap",[""],function(){function e(e){this.content=[];this.scoreFunction=e}e.prototype={push:function(e){this.content.push(e);this.sinkDown(this.content.length-1)},pop:function(){var e=this.content[0],n=this.content.pop();if(this.content.length>0){this.content[0]=n;this.bubbleUp(0)}return e},remove:function(e){var n=this.content.indexOf(e),t=this.content.pop();if(n!==this.content.length-1){this.content[n]=t;this.scoreFunction(t)<this.scoreFunction(e)?this.sinkDown(n):this.bubbleUp(n)}},size:function(){return this.content.length},rescoreElement:function(e){this.sinkDown(this.content.indexOf(e))},sinkDown:function(e){for(var n=this.content[e];e>0;){var t=(e+1>>1)-1,r=this.content[t];if(!(this.scoreFunction(n)<this.scoreFunction(r)))break;this.content[t]=n;this.content[e]=r;e=t}},bubbleUp:function(e){for(var n=this.content.length,t=this.content[e],r=this.scoreFunction(t);;){var i=e+1<<1,o=i-1,a=null;if(n>o){var c=this.content[o],s=this.scoreFunction(c);r>s&&(a=o)}if(n>i){var u=this.content[i],p=this.scoreFunction(u);(null===a?r:s)>p&&(a=i)}if(null===a)break;this.content[e]=this.content[a];this.content[a]=t;e=a}}};return e});define("astar",["binaryHeap"],function(e){var n={init:function(e){for(var n=0,t=e.length;t>n;n++)for(var r=0,i=e[n].length;i>r;r++){var o=e[n][r];o.f=0;o.g=0;o.h=0;o.cost=o.type;o.visited=!1;o.closed=!1;o.parent=null}},heap:function(){return new e(function(e){return e.f})},search:function(e,t,r,i,o){n.init(e);o=o||n.manhattan;i=!!i;var a=n.heap();a.push(t);for(;a.size()>0;){var c=a.pop();if(c===r){for(var s=c,u=[];s.parent;){u.push(s);s=s.parent}return u.reverse()}c.closed=!0;for(var p=n.neighbors(e,c,i),l=0,f=p.length;f>l;l++){var d=p[l];if(!d.closed&&!d.isWall()){var h=c.g+d.cost,v=d.visited;if(!v||h<d.g){d.visited=!0;d.parent=c;d.h=d.h||o(d.pos,r.pos);d.g=h;d.f=d.g+d.h;v?a.rescoreElement(d):a.push(d)}}}}return[]},manhattan:function(e,n){var t=Math.abs(n.x-e.x),r=Math.abs(n.y-e.y);return t+r},neighbors:function(e,n,t){var r=[],i=n.x,o=n.y;e[i-1]&&e[i-1][o]&&r.push(e[i-1][o]);e[i+1]&&e[i+1][o]&&r.push(e[i+1][o]);e[i]&&e[i][o-1]&&r.push(e[i][o-1]);e[i]&&e[i][o+1]&&r.push(e[i][o+1]);if(t){e[i-1]&&e[i-1][o-1]&&r.push(e[i-1][o-1]);e[i+1]&&e[i+1][o-1]&&r.push(e[i+1][o-1]);e[i-1]&&e[i-1][o+1]&&r.push(e[i-1][o+1]);e[i+1]&&e[i+1][o+1]&&r.push(e[i+1][o+1])}return r}};return n});define("actor.unit",["actor","eventmanager","astar","world"],function(e,n,t,r){return function(i){var o=e(i),a={path:[],focus:"",strenght:0,dexterity:0,intelligence:0,health:0,death:!1,hp:0,attack:10},c={"new.gamecycle":"move"};_.extend(o.variables,a);_.extend(o.handlers.subscribe,c);o.generatePath=function(){var e=r.graph.nodes[o.variables.coordinates.y][o.variables.coordinates.x],n=r.graph.nodes[o.variables.goal.y][o.variables.goal.x];o.variables.path=t.search(r.graph.nodes,e,n,!0)};o.move=function(){if(0!==o.variables.path.length){var e=_.first(o.variables.path);o.variables.path=_.rest(o.variables.path);var t={x:o.variables.coordinates.x-e.y,y:o.variables.coordinates.y-e.x};-1==t.x?o.variables.direction=0:1==t.x?o.variables.direction=2:-1==t.y?o.variables.direction=1:1==t.y&&(o.variables.direction=3);o.variables.coordinates={x:e.y,y:e.x};n.publish("command",{event:"actor.update",parameters:o})}};return o}});define("actor.unit.local",["actor.unit","eventmanager"],function(e){return function(n){var t=e(n),r={focus:"",state:"base"};_.extend(t.variables,r);var i={"map.click":"checkMapClick"};_.extend(t.handlers.subscribe,i);t.checkMapClick=function(e){if(t.variables.selected){t.variables.goal=e;t.generatePath()}};return t}});define("plane",["actor.unit.local","eventmanager"],function(e){return function(n){var t=e(n),r={focus:"",state:"base",direction:0,sprite:{center:{x:24,y:20},base:{0:["plane/base/Plane_Large_face0_0.png","plane/base/Plane_Large_face0_1.png","plane/base/Plane_Large_face0_2.png","plane/base/Plane_Large_face0_3.png"],1:["plane/base/Plane_Large_face1_0.png","plane/base/Plane_Large_face1_1.png","plane/base/Plane_Large_face1_2.png","plane/base/Plane_Large_face1_3.png"],2:["plane/base/Plane_Large_face2_0.png","plane/base/Plane_Large_face2_1.png","plane/base/Plane_Large_face2_2.png","plane/base/Plane_Large_face2_3.png"],3:["plane/base/Plane_Large_face3_0.png","plane/base/Plane_Large_face3_1.png","plane/base/Plane_Large_face3_2.png","plane/base/Plane_Large_face3_3.png"]},explode:{0:["plane/explode/color0_Plane_Large_face0_fiery_explode_0.png","plane/explode/color0_Plane_Large_face0_fiery_explode_1.png","plane/explode/color0_Plane_Large_face0_fiery_explode_2.png","plane/explode/color0_Plane_Large_face0_fiery_explode_3.png","plane/explode/color0_Plane_Large_face0_fiery_explode_4.png","plane/explode/color0_Plane_Large_face0_fiery_explode_5.png","plane/explode/color0_Plane_Large_face0_fiery_explode_6.png","plane/explode/color0_Plane_Large_face0_fiery_explode_7.png","plane/explode/color0_Plane_Large_face0_fiery_explode_8.png","plane/explode/color0_Plane_Large_face0_fiery_explode_9.png","plane/explode/color0_Plane_Large_face0_fiery_explode_10.png","plane/explode/color0_Plane_Large_face0_fiery_explode_11.png"],1:["plane/explode/color0_Plane_Large_face1_fiery_explode_0.png","plane/explode/color0_Plane_Large_face1_fiery_explode_1.png","plane/explode/color0_Plane_Large_face1_fiery_explode_2.png","plane/explode/color0_Plane_Large_face1_fiery_explode_3.png","plane/explode/color0_Plane_Large_face1_fiery_explode_4.png","plane/explode/color0_Plane_Large_face1_fiery_explode_5.png","plane/explode/color0_Plane_Large_face1_fiery_explode_6.png","plane/explode/color0_Plane_Large_face1_fiery_explode_7.png","plane/explode/color0_Plane_Large_face1_fiery_explode_8.png","plane/explode/color0_Plane_Large_face1_fiery_explode_9.png","plane/explode/color0_Plane_Large_face1_fiery_explode_10.png","plane/explode/color0_Plane_Large_face1_fiery_explode_11.png"],2:["plane/explode/color0_Plane_Large_face2_fiery_explode_0.png","plane/explode/color0_Plane_Large_face2_fiery_explode_1.png","plane/explode/color0_Plane_Large_face2_fiery_explode_2.png","plane/explode/color0_Plane_Large_face2_fiery_explode_3.png","plane/explode/color0_Plane_Large_face2_fiery_explode_4.png","plane/explode/color0_Plane_Large_face2_fiery_explode_5.png","plane/explode/color0_Plane_Large_face2_fiery_explode_6.png","plane/explode/color0_Plane_Large_face2_fiery_explode_7.png","plane/explode/color0_Plane_Large_face2_fiery_explode_8.png","plane/explode/color0_Plane_Large_face2_fiery_explode_9.png","plane/explode/color0_Plane_Large_face2_fiery_explode_10.png","plane/explode/color0_Plane_Large_face2_fiery_explode_11.png"],3:["plane/explode/color0_Plane_Large_face3_fiery_explode_0.png","plane/explode/color0_Plane_Large_face3_fiery_explode_1.png","plane/explode/color0_Plane_Large_face3_fiery_explode_2.png","plane/explode/color0_Plane_Large_face3_fiery_explode_3.png","plane/explode/color0_Plane_Large_face3_fiery_explode_4.png","plane/explode/color0_Plane_Large_face3_fiery_explode_5.png","plane/explode/color0_Plane_Large_face3_fiery_explode_6.png","plane/explode/color0_Plane_Large_face3_fiery_explode_7.png","plane/explode/color0_Plane_Large_face3_fiery_explode_8.png","plane/explode/color0_Plane_Large_face3_fiery_explode_9.png","plane/explode/color0_Plane_Large_face3_fiery_explode_10.png","plane/explode/color0_Plane_Large_face3_fiery_explode_11.png"]}},health:75,death:!1,hp:100};_.extend(t.variables,r);return t}});define("spriteSheet",[""],function(){var e=function(e,n){var t=[],r=e,i=n,o=function(){_.forEach(r.frames,function(e){var n=e,t=.5*-n.frame.w,r=.5*-n.frame.h;if(n.trimmed){t=n.spriteSourceSize.x-.5*n.sourceSize.w;r=n.spriteSourceSize.y-.5*n.sourceSize.h}a(n.filename,n.frame.x,n.frame.y,n.frame.w,n.frame.h,t,r)})},a=function(e,n,r,i,o,a,c){var s={id:e,x:n,y:r,w:i,h:o,cx:null===a?0:a,cy:null===c?0:c};t.push(s)};o();return{img:i,sprites:t}};return e});define("text!assetsList",[],function(){return'{\n  "0" : {\n    "name": "mapTiles",\n    "type": "atlas",\n    "configuration": "./art/panama.json",\n    "file": "./art/panama.png"\n  }\n}'});!function(e){if("function"==typeof bootstrap)bootstrap("promise",e);else if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define("q",e);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=e}else{if("undefined"==typeof self)throw new Error("This environment was not anticiapted by Q. Please file a bug.");self.Q=e()}}(function(){function e(e){return function(){return B.apply(e,arguments)}}function n(e){return e===Object(e)}function t(e){return"[object StopIteration]"===nn(e)||e instanceof q}function r(e,n){if(F&&n.stack&&"object"==typeof e&&null!==e&&e.stack&&-1===e.stack.indexOf(tn)){for(var t=[],r=n;r;r=r.source)r.stack&&t.unshift(r.stack);t.unshift(e.stack);var o=t.join("\n"+tn+"\n");e.stack=i(o)}}function i(e){for(var n=e.split("\n"),t=[],r=0;r<n.length;++r){var i=n[r];c(i)||o(i)||!i||t.push(i)}return t.join("\n")}function o(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function a(e){var n=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(n)return[n[1],Number(n[2])];var t=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(t)return[t[1],Number(t[2])];var r=/.*@(.+):(\d+)$/.exec(e);return r?[r[1],Number(r[2])]:void 0}function c(e){var n=a(e);if(!n)return!1;var t=n[0],r=n[1];return t===U&&r>=X&&cn>=r}function s(){if(F)try{throw new Error}catch(e){var n=e.stack.split("\n"),t=n[0].indexOf("@")>0?n[1]:n[2],r=a(t);if(!r)return;U=r[0];return r[1]}}function u(e,n,t){return function(){"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(n+" is deprecated, use "+t+" instead.",new Error("").stack);return e.apply(e,arguments)}}function p(e){return e instanceof h?e:y(e)?T(e):j(e)}function l(){function e(e){n=e;o.source=e;Q(t,function(n,t){p.nextTick(function(){e.promiseDispatch.apply(e,t)})},void 0);t=void 0;r=void 0}var n,t=[],r=[],i=K(l.prototype),o=K(h.prototype);o.promiseDispatch=function(e,i,o){var a=G(arguments);if(t){t.push(a);"when"===i&&o[1]&&r.push(o[1])}else p.nextTick(function(){n.promiseDispatch.apply(n,a)})};o.valueOf=function(){if(t)return o;var e=_(n);g(e)&&(n=e);return e};o.inspect=function(){return n?n.inspect():{state:"pending"}};if(p.longStackSupport&&F)try{throw new Error}catch(a){o.stack=a.stack.substring(a.stack.indexOf("\n")+1)}i.promise=o;i.resolve=function(t){n||e(p(t))};i.fulfill=function(t){n||e(j(t))};i.reject=function(t){n||e(k(t))};i.notify=function(e){n||Q(r,function(n,t){p.nextTick(function(){t(e)})},void 0)};return i}function f(e){if("function"!=typeof e)throw new TypeError("resolver must be a function.");var n=l();try{e(n.resolve,n.reject,n.notify)}catch(t){n.reject(t)}return n.promise}function d(e){return f(function(n,t){for(var r=0,i=e.length;i>r;r++)p(e[r]).then(n,t)})}function h(e,n,t){void 0===n&&(n=function(e){return k(new Error("Promise does not support operation: "+e))});void 0===t&&(t=function(){return{state:"unknown"}});var r=K(h.prototype);r.promiseDispatch=function(t,i,o){var a;try{a=e[i]?e[i].apply(r,o):n.call(r,i,o)}catch(c){a=k(c)}t&&t(a)};r.inspect=t;if(t){var i=t();"rejected"===i.state&&(r.exception=i.reason);r.valueOf=function(){var e=t();return"pending"===e.state||"rejected"===e.state?r:e.value}}return r}function v(e,n,t,r){return p(e).then(n,t,r)}function _(e){if(g(e)){var n=e.inspect();if("fulfilled"===n.state)return n.value}return e}function g(e){return e instanceof h}function y(e){return n(e)&&"function"==typeof e.then}function m(e){return g(e)&&"pending"===e.inspect().state}function x(e){return!g(e)||"fulfilled"===e.inspect().state}function b(e){return g(e)&&"rejected"===e.inspect().state}function w(){rn.length=0;on.length=0;an||(an=!0)}function P(e,n){if(an){on.push(e);rn.push(n&&"undefined"!=typeof n.stack?n.stack:"(no stack) "+n)}}function L(e){if(an){var n=V(on,e);if(-1!==n){on.splice(n,1);rn.splice(n,1)}}}function k(e){var n=h({when:function(n){n&&L(this);return n?n(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});P(n,e);return n}function j(e){return h({when:function(){return e},get:function(n){return e[n]},set:function(n,t){e[n]=t},"delete":function(n){delete e[n]},post:function(n,t){return null===n||void 0===n?e.apply(void 0,t):e[n].apply(e,t)},apply:function(n,t){return e.apply(n,t)},keys:function(){return en(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function T(e){var n=l();p.nextTick(function(){try{e.then(n.resolve,n.reject,n.notify)}catch(t){n.reject(t)}});return n.promise}function R(e){return h({isDef:function(){}},function(n,t){return D(e,n,t)},function(){return p(e).inspect()})}function S(e,n,t){return p(e).spread(n,t)}function W(e){return function(){function n(e,n){var a;if("undefined"==typeof StopIteration){try{a=r[e](n)}catch(c){return k(c)}return a.done?p(a.value):v(a.value,i,o)}try{a=r[e](n)}catch(c){return t(c)?p(c.value):k(c)}return v(a,i,o)}var r=e.apply(this,arguments),i=n.bind(n,"next"),o=n.bind(n,"throw");return i()}}function E(e){p.done(p.async(e)())}function I(e){throw new q(e)}function O(e){return function(){return S([this,H(arguments)],function(n,t){return e.apply(n,t)})}}function D(e,n,t){return p(e).dispatch(n,t)}function H(e){return v(e,function(e){var n=0,t=l();Q(e,function(r,i,o){var a;if(g(i)&&"fulfilled"===(a=i.inspect()).state)e[o]=a.value;else{++n;v(i,function(r){e[o]=r;0===--n&&t.resolve(e)},t.reject,function(e){t.notify({index:o,value:e})})}},void 0);0===n&&t.resolve(e);return t.promise})}function $(e){return v(e,function(e){e=J(e,p);return v(H(J(e,function(e){return v(e,Y,Y)})),function(){return e})})}function A(e){return p(e).allSettled()}function C(e,n){return p(e).then(void 0,void 0,n)}function M(e,n){return p(e).nodeify(n)}var F=!1;try{throw new Error}catch(N){F=!!N.stack}var U,q,X=s(),Y=function(){},z=function(){function e(){for(;n.next;){n=n.next;var t=n.task;n.task=void 0;var i=n.domain;if(i){n.domain=void 0;i.enter()}try{t()}catch(a){if(o){i&&i.exit();setTimeout(e,0);i&&i.enter();throw a}setTimeout(function(){throw a},0)}i&&i.exit()}r=!1}var n={task:void 0,next:null},t=n,r=!1,i=void 0,o=!1;z=function(e){t=t.next={task:e,domain:o&&process.domain,next:null};if(!r){r=!0;i()}};if("undefined"!=typeof process&&process.nextTick){o=!0;i=function(){process.nextTick(e)}}else if("function"==typeof setImmediate)i="undefined"!=typeof window?setImmediate.bind(window,e):function(){setImmediate(e)};else if("undefined"!=typeof MessageChannel){var a=new MessageChannel;a.port1.onmessage=function(){i=c;a.port1.onmessage=e;e()};var c=function(){a.port2.postMessage(0)};i=function(){setTimeout(e,0);c()}}else i=function(){setTimeout(e,0)};return z}(),B=Function.call,G=e(Array.prototype.slice),Q=e(Array.prototype.reduce||function(e,n){var t=0,r=this.length;if(1===arguments.length)for(;;){if(t in this){n=this[t++];break}if(++t>=r)throw new TypeError}for(;r>t;t++)t in this&&(n=e(n,this[t],t));return n}),V=e(Array.prototype.indexOf||function(e){for(var n=0;n<this.length;n++)if(this[n]===e)return n;return-1}),J=e(Array.prototype.map||function(e,n){var t=this,r=[];Q(t,function(i,o,a){r.push(e.call(n,o,a,t))},void 0);return r}),K=Object.create||function(e){function n(){}n.prototype=e;return new n},Z=e(Object.prototype.hasOwnProperty),en=Object.keys||function(e){var n=[];for(var t in e)Z(e,t)&&n.push(t);return n},nn=e(Object.prototype.toString);q="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};var tn="From previous event:";p.resolve=p;p.nextTick=z;p.longStackSupport=!1;"object"==typeof process&&process&&process.env&&process.env.Q_DEBUG&&(p.longStackSupport=!0);p.defer=l;l.prototype.makeNodeResolver=function(){var e=this;return function(n,t){n?e.reject(n):e.resolve(arguments.length>2?G(arguments,1):t)}};p.Promise=f;p.promise=f;f.race=d;f.all=H;f.reject=k;f.resolve=p;p.passByCopy=function(e){return e};h.prototype.passByCopy=function(){return this};p.join=function(e,n){return p(e).join(n)};h.prototype.join=function(e){return p([this,e]).spread(function(e,n){if(e===n)return e;throw new Error("Can't join: not the same: "+e+" "+n)})};p.race=d;h.prototype.race=function(){return this.then(p.race)};p.makePromise=h;h.prototype.toString=function(){return"[object Promise]"};h.prototype.then=function(e,n,t){function i(n){try{return"function"==typeof e?e(n):n}catch(t){return k(t)}}function o(e){if("function"==typeof n){r(e,c);try{return n(e)}catch(t){return k(t)}}return k(e)}function a(e){return"function"==typeof t?t(e):e}var c=this,s=l(),u=!1;p.nextTick(function(){c.promiseDispatch(function(e){if(!u){u=!0;s.resolve(i(e))}},"when",[function(e){if(!u){u=!0;s.resolve(o(e))}}])});c.promiseDispatch(void 0,"when",[void 0,function(e){var n,t=!1;try{n=a(e)}catch(r){t=!0;if(!p.onerror)throw r;p.onerror(r)}t||s.notify(n)}]);return s.promise};p.tap=function(e,n){return p(e).tap(n)};h.prototype.tap=function(e){e=p(e);return this.then(function(n){return e.fcall(n).thenResolve(n)})};p.when=v;h.prototype.thenResolve=function(e){return this.then(function(){return e})};p.thenResolve=function(e,n){return p(e).thenResolve(n)};h.prototype.thenReject=function(e){return this.then(function(){throw e})};p.thenReject=function(e,n){return p(e).thenReject(n)};p.nearer=_;p.isPromise=g;p.isPromiseAlike=y;p.isPending=m;h.prototype.isPending=function(){return"pending"===this.inspect().state};p.isFulfilled=x;h.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};p.isRejected=b;h.prototype.isRejected=function(){return"rejected"===this.inspect().state};var rn=[],on=[],an=!0;p.resetUnhandledRejections=w;p.getUnhandledReasons=function(){return rn.slice()};p.stopUnhandledRejectionTracking=function(){w();an=!1};w();p.reject=k;p.fulfill=j;p.master=R;p.spread=S;h.prototype.spread=function(e,n){return this.all().then(function(n){return e.apply(void 0,n)},n)};p.async=W;p.spawn=E;p["return"]=I;p.promised=O;p.dispatch=D;h.prototype.dispatch=function(e,n){var t=this,r=l();p.nextTick(function(){t.promiseDispatch(r.resolve,e,n)});return r.promise};p.get=function(e,n){return p(e).dispatch("get",[n])};h.prototype.get=function(e){return this.dispatch("get",[e])};p.set=function(e,n,t){return p(e).dispatch("set",[n,t])};h.prototype.set=function(e,n){return this.dispatch("set",[e,n])};p.del=p["delete"]=function(e,n){return p(e).dispatch("delete",[n])};h.prototype.del=h.prototype["delete"]=function(e){return this.dispatch("delete",[e])};p.mapply=p.post=function(e,n,t){return p(e).dispatch("post",[n,t])};h.prototype.mapply=h.prototype.post=function(e,n){return this.dispatch("post",[e,n])};p.send=p.mcall=p.invoke=function(e,n){return p(e).dispatch("post",[n,G(arguments,2)])};h.prototype.send=h.prototype.mcall=h.prototype.invoke=function(e){return this.dispatch("post",[e,G(arguments,1)])};p.fapply=function(e,n){return p(e).dispatch("apply",[void 0,n])};h.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])};p["try"]=p.fcall=function(e){return p(e).dispatch("apply",[void 0,G(arguments,1)])};h.prototype.fcall=function(){return this.dispatch("apply",[void 0,G(arguments)])};p.fbind=function(e){var n=p(e),t=G(arguments,1);return function(){return n.dispatch("apply",[this,t.concat(G(arguments))])}};h.prototype.fbind=function(){var e=this,n=G(arguments);return function(){return e.dispatch("apply",[this,n.concat(G(arguments))])}};p.keys=function(e){return p(e).dispatch("keys",[])};h.prototype.keys=function(){return this.dispatch("keys",[])};p.all=H;h.prototype.all=function(){return H(this)};p.allResolved=u($,"allResolved","allSettled");h.prototype.allResolved=function(){return $(this)};p.allSettled=A;h.prototype.allSettled=function(){return this.then(function(e){return H(J(e,function(e){function n(){return e.inspect()}e=p(e);return e.then(n,n)}))})};p.fail=p["catch"]=function(e,n){return p(e).then(void 0,n)};h.prototype.fail=h.prototype["catch"]=function(e){return this.then(void 0,e)};p.progress=C;h.prototype.progress=function(e){return this.then(void 0,void 0,e)};p.fin=p["finally"]=function(e,n){return p(e)["finally"](n)};h.prototype.fin=h.prototype["finally"]=function(e){e=p(e);return this.then(function(n){return e.fcall().then(function(){return n})},function(n){return e.fcall().then(function(){throw n})})};p.done=function(e,n,t,r){return p(e).done(n,t,r)};h.prototype.done=function(e,n,t){var i=function(e){p.nextTick(function(){r(e,o);if(!p.onerror)throw e;p.onerror(e)})},o=e||n||t?this.then(e,n,t):this;"object"==typeof process&&process&&process.domain&&(i=process.domain.bind(i));o.then(void 0,i)};p.timeout=function(e,n,t){return p(e).timeout(n,t)};h.prototype.timeout=function(e,n){var t=l(),r=setTimeout(function(){if(!n||"string"==typeof n){n=new Error(n||"Timed out after "+e+" ms");n.code="ETIMEDOUT"}t.reject(n)},e);this.then(function(e){clearTimeout(r);t.resolve(e)},function(e){clearTimeout(r);t.reject(e)},t.notify);return t.promise};p.delay=function(e,n){if(void 0===n){n=e;e=void 0}return p(e).delay(n)};h.prototype.delay=function(e){return this.then(function(n){var t=l();setTimeout(function(){t.resolve(n)},e);return t.promise})};p.nfapply=function(e,n){return p(e).nfapply(n)};h.prototype.nfapply=function(e){var n=l(),t=G(e);t.push(n.makeNodeResolver());this.fapply(t).fail(n.reject);return n.promise};p.nfcall=function(e){var n=G(arguments,1);return p(e).nfapply(n)};h.prototype.nfcall=function(){var e=G(arguments),n=l();e.push(n.makeNodeResolver());this.fapply(e).fail(n.reject);return n.promise};p.nfbind=p.denodeify=function(e){var n=G(arguments,1);return function(){var t=n.concat(G(arguments)),r=l();t.push(r.makeNodeResolver());p(e).fapply(t).fail(r.reject);return r.promise}};h.prototype.nfbind=h.prototype.denodeify=function(){var e=G(arguments);e.unshift(this);return p.denodeify.apply(void 0,e)};p.nbind=function(e,n){var t=G(arguments,2);return function(){function r(){return e.apply(n,arguments)}var i=t.concat(G(arguments)),o=l();i.push(o.makeNodeResolver());p(r).fapply(i).fail(o.reject);return o.promise}};h.prototype.nbind=function(){var e=G(arguments,0);e.unshift(this);return p.nbind.apply(void 0,e)};p.nmapply=p.npost=function(e,n,t){return p(e).npost(n,t)};h.prototype.nmapply=h.prototype.npost=function(e,n){var t=G(n||[]),r=l();t.push(r.makeNodeResolver());this.dispatch("post",[e,t]).fail(r.reject);return r.promise};p.nsend=p.nmcall=p.ninvoke=function(e,n){var t=G(arguments,2),r=l();t.push(r.makeNodeResolver());p(e).dispatch("post",[n,t]).fail(r.reject);return r.promise};h.prototype.nsend=h.prototype.nmcall=h.prototype.ninvoke=function(e){var n=G(arguments,1),t=l();n.push(t.makeNodeResolver());this.dispatch("post",[e,n]).fail(t.reject);return t.promise};p.nodeify=M;h.prototype.nodeify=function(e){if(!e)return this;this.then(function(n){p.nextTick(function(){e(null,n)})},function(n){p.nextTick(function(){e(n)})});return void 0};var cn=s();return p});define("assetLoader",["spriteSheet","text!assetsList","q","eventmanager"],function(e,n,t,r){var i={config:{},loaded:{atlas:[],music:[]}};i.config=JSON.parse(n);var o=function(){_.forEach(i.config,function(n){switch(n.type){case"atlas":jQuery.getJSON(n.configuration,function(e){n.configuration=e}).then(function(){var t=new Image;t.src=n.file;t.onload=function(){i.loaded.atlas.push({name:n.name,sprite:new e(n.configuration,t)});r.publish("game.init")}});break;case"music":}})};return{preloadassets:o,assets:i}});define("commandQueue",[""],function(){function e(e){r.push(e)}function n(){r=[]}function t(){return r}var r=[];return{add:e,get:t,clear:n}});define("command",["commandQueue","eventmanager"],function(e,n){function t(n){e.add(n)}function r(){var t=e.get();_.forEach(t,function(e){n.publish(e.event,e.parameters)});e.clear()}n.subscribe("command",function(e){t(e)});n.subscribe("new.gamecycle",function(){r()})});define("gamecycle",["eventmanager","command"],function(e){function n(){t()}function t(){setTimeout(t,200);e.publish("new.gamecycle")}e.subscribe("game.init",function(){n()})});define("RequestAnimationFrame",[""],function(){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/16.5)}}()});define("map",["eventmanager","world","standardlib","assetLoader"],function(e,n,t,r){function i(){l.canvas=document.getElementById("mapCanvas");l.context=l.canvas.getContext("2d");l.canvas.width=n.width*n.tileWidth;l.canvas.height=n.height*n.tileHeight;l.canvas.addEventListener("contextmenu",function(n){var r=l.canvas.relmouseCoordinates(n);r=t.worldPosToGridPos(r.x,r.y);e.publish("map.click",r)});l.canvas.addEventListener("mousedown",function(e){if(1==e.which){$(".ghost-select").addClass("ghost-active");$(".ghost-select").css({left:e.pageX,top:e.pageY});initialW=e.pageX;initialH=e.pageY;$(document).bind("mouseup",o);$(document).bind("mousemove",a)}});c();u()}function o(){$(document).unbind("mousemove",a);$(document).unbind("mouseup",o);var n=$(".ghost-select");e.publish("map.selection",{width:n.width(),height:n.height(),left:n.offset().left,top:n.offset().top});$(".ghost-select").css({left:0,top:0,width:0,height:0}).removeClass("ghost-active")}function a(e){var n=Math.abs(initialW-e.pageX),t=Math.abs(initialH-e.pageY);$(".ghost-select").css({width:n,height:t});e.pageX<=initialW&&e.pageY>=initialH?$(".ghost-select").css({left:e.pageX}):e.pageY<=initialH&&e.pageX>=initialW?$(".ghost-select").css({top:e.pageY}):e.pageY<initialH&&e.pageX<initialW&&$(".ghost-select").css({left:e.pageX,top:e.pageY})}function c(){l.context.clearRect(0,0,l.canvas.width,l.canvas.height);for(var e={x:0,y:0},t=0;n.height>t;t++)for(var r=0;n.width>r;r++)n.outOfBound(e.y+t,e.x+r)||s(1===n.mapData[e.y+t][e.x+r]?{sprite:"trees_2.png",x:e.x+r,y:e.y+t,correction:15}:{sprite:"landscapeTiles_066.png",x:e.x+r,y:e.y+t,correction:15})}function s(e){var i,o,a;_.findIndex(r.assets.loaded.atlas,function(n){i=_.findWhere(n.sprite.sprites,{id:e.sprite});a=n.sprite.img;!_.isEmpty(n)});if(!_.isEmpty(i)){o=t.twoDToIso(e.x,e.y);o.x=o.x*n.tileWidth+l.canvas.width/2-(i.w-n.tileWidth)/2-n.tileWidth/2;o.y=o.y*n.tileHeight+(i.w/2-(i.h-e.correction));l.context.drawImage(a,i.x,i.y,i.w,i.h,o.x,o.y,i.w,i.h)}}function u(){var e=window.innerWidth/2,t=window.innerHeight/2,r={};r.x=-(n.center.x*n.tileWidth+l.canvas.width/2-e);r.y=-(n.center.y*n.tileHeight)+t;$(l.canvas).css("margin-left",r.x).css("margin-top",r.y)}function p(){u(n.center)}var l={};e.subscribe("new.frame",function(){p()});e.subscribe("game.init",function(){i()})});define("actors",["eventmanager","standardlib","world","actorList","assetLoader"],function(e,n,t,r,i){function o(){_.each(r.getCleanUpList(),function(e){$("canvas."+e.uuid).remove()
});r.clearCleanUpList();_.each(r.getActorList(),function(n){if(u(n.variables.coordinates))if(n.variables.rendered)a(n);else{$(".ActorsWrapper").append('<canvas id="'+n.variables.uuid+'"></canvas>');n.variables.canvas=document.getElementById(n.variables.uuid);n.variables.canvas.context=n.variables.canvas.getContext("2d");n.variables.canvas.addEventListener("click",function(){e.publish("actor.selected",n.variables.uuid)});n.variables.rendered=!0;a(n)}else if(n.variables.rendered){$("canvas#"+n.variables.uuid).remove();n.variables.rendered=!1;n.variables.canvas=""}})}function a(e){c(e);s(e)}function c(e){var r=window.innerWidth/t.tileWidth,i=window.innerHeight/t.tileHeight,o=n.twoDToIso(e.variables.coordinates.x,e.variables.coordinates.y),a=t.center,c=o.y-a.y,s=(i/2-c-1)*t.tileHeight+20;$(e.variables.canvas).css("z-index",e.variables.coordinates.y).css("bottom",s);var u=o.x-(a.x-r/2),p=u*t.tileWidth-e.variables.sprite.center.x;$(e.variables.canvas).css("left",p)}function s(e){e.variables.canvas.context.clearRect(0,0,e.variables.canvas.width,e.variables.canvas.height);"undefined"==typeof e.variables.sprite[e.variables.state][e.variables.direction][e.variables.spriteIndex]&&(e.variables.spriteIndex=0);p({sprite:e.variables.sprite[e.variables.state][e.variables.direction][e.variables.spriteIndex],canvas:e.variables.canvas});e.variables.selected&&l({canvas:e.variables.canvas,health:e.variables.health,hp:e.variables.hp});e.variables.spriteIndex++}function u(e){var r=n.twoDToIso(e.x,e.y),i=t.center,o=Math.ceil(window.innerWidth/t.tileWidth),a=Math.ceil(window.innerHeight/t.tileHeight);return r.x>=i.x-o/2&&r.x<=i.x+o/2&&r.y>=i.y-a/2&&r.y<=i.y+a/2?!0:!1}function p(e){var n,t;_.findIndex(i.assets.loaded.atlas,function(r){n=_.findWhere(r.sprite.sprites,{id:e.sprite});t=r.sprite.img;!_.isEmpty(r)});if(!_.isEmpty(n)){e.canvas.width=n.w;e.canvas.height=n.h+d;e.canvas.context.drawImage(t,n.x,n.y,n.w,n.h,0,d,n.w,n.h)}}function l(e){e.canvas.context.fillStyle="red";e.canvas.context.fillRect((e.canvas.width-40)/2,0,38,d-2);e.canvas.context.fillStyle="green";var n=e.health/e.hp;e.canvas.context.fillRect((e.canvas.width-40)/2,0,38*n,d-2)}function f(e){var i=window.innerWidth/2,o=window.innerHeight/2,a={};a.x=-(t.center.x*t.tileWidth+t.width*t.tileWidth/2-i);a.y=-(t.center.y*t.tileHeight)+o;var c=-a.x+e.left,s=-a.y+e.top,u=n.worldPosToGridPos(c,s);u=n.twoDToIso(u.x,u.y);var p=n.worldPosToGridPos(c+e.width,s+e.height);p=n.twoDToIso(p.x,p.y);_.each(r.getActorList(),function(e){var t=n.twoDToIso(e.variables.coordinates.x,e.variables.coordinates.y);e.variables.selected=t.x>=u.x&&t.x<=p.x&&t.y>=u.y&&t.y<=p.y?!0:!1})}var d=7.5;e.subscribe("new.frame",function(){o()});e.subscribe("center.update.start",function(){$(".ActorsWrapper").removeClass("no-panning")});e.subscribe("center.update.stop",function(){$(".ActorsWrapper").addClass("no-panning")});e.subscribe("map.selection",function(e){f(e)})});define("animate",["eventmanager","RequestAnimationFrame","map","actors"],function(e){function n(){e.publish("new.frame");window.setTimeout(n,100)}e.subscribe("game.init",function(){n()});return{}});define("mouse",["eventmanager"],function(e){HTMLCanvasElement.prototype.relmouseCoordinates=function(e){var n=0,t=0,r=0,i=0,o=this;do{n+=o.offsetLeft-o.scrollLeft;t+=o.offsetTop-o.scrollTop}while(o===o.offsetParent);r=e.pageX-n;i=e.pageY-t;return{x:r,y:i}};window.oncontextmenu=function(e){e.preventDefault();e.stopPropagation();return!1};var n=function(){};e.subscribe("game.init",function(){n()})});define("input",["eventmanager","mouse","Keypress"],function(e,n,t){var r=new t.Listener,i=[{keys:"up",prevent_repeat:!0,on_keydown:function(){e.publish("pan.up",1)},on_keyup:function(){e.publish("pan.up",0)}},{keys:"down",prevent_repeat:!0,on_keydown:function(){e.publish("pan.down",1)},on_keyup:function(){e.publish("pan.down",0)}},{keys:"left",prevent_repeat:!0,on_keydown:function(){e.publish("pan.left",1)},on_keyup:function(){e.publish("pan.left",0)}},{keys:"right",prevent_repeat:!0,on_keydown:function(){e.publish("pan.right",1)},on_keyup:function(){e.publish("pan.right",0)}}];r.register_many(i)});define("scripts/app",["lodash","jquery","plane","assetLoader","eventmanager","gamecycle","animate","input"],function(e,n,t,r){r.preloadassets();t({coordinates:{x:30,y:30}}).init();t({coordinates:{x:29,y:30}}).init();t({coordinates:{x:31,y:30}}).init();t({coordinates:{x:30,y:29}}).init();t({coordinates:{x:30,y:31}}).init();t({coordinates:{x:33,y:30}}).init();t({coordinates:{x:29,y:31}}).init();t({coordinates:{x:31,y:31}}).init();t({coordinates:{x:30,y:28}}).init()});